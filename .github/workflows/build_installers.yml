name: "(D) ðŸ“¦ï¸ Build Installers"

on:
  workflow_dispatch:
  workflow_call:

permissions:
  contents: write

jobs:
  build-installer:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Install deps
        working-directory: ./static/installers/stub-win64-installer
        run: pnpm install

      - name: Build installer
        working-directory: ./static/installers/stub-win64-installer
        run: pnpm tauri build

      # âœ… Windows safe copy
      - name: Copy installer
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force output | Out-Null
          Copy-Item "./static/installers/stub-win64-installer/src-tauri/target/release/stub-installer.exe" "output/floorp-stub.installer.exe"

      - name: Upload unsigned artifact
        id: unsigned
        uses: actions/upload-artifact@v4
        with:
          name: floorp-stub-installer-unsigned
          path: output/floorp-stub.installer.exe

      - name: Sign installer
        uses: signpath/github-action-submit-signing-request@v1.1
        with:
          api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
          organization-id: "3b13ba3b-8062-4df7-a4a6-217a5ec352c4"
          project-slug: "Floorp"
          signing-policy-slug: "release-signing"
          artifact-configuration-slug: "stub-v2-signing"
          github-artifact-id: ${{ steps.unsigned.outputs.artifact-id }}
          wait-for-completion: true
          output-artifact-directory: output/signed_installer

      - name: Upload signed artifact
        uses: actions/upload-artifact@v4
        with:
          name: floorp-stub-installer
          path: output/signed_installer/floorp-stub.installer.exe

      # ðŸ”¥ version plus simple sans PAT
      - name: Get latest release
        id: release
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.repos.getLatestRelease({
              owner: "Floorp-Projects",
              repo: "Floorp"
            });

            core.setOutput("tag", data.tag_name);

            const asset = data.assets.find(a => a.name === "floorp-stub.installer.exe");
            core.setOutput("asset_id", asset?.id || "");

      - name: Delete old asset
        if: steps.release.outputs.asset_id != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.deleteReleaseAsset({
              owner: "Floorp-Projects",
              repo: "Floorp",
              asset_id: Number("${{ steps.release.outputs.asset_id }}")
            });

      - name: Upload to release ðŸš€
        uses: softprops/action-gh-release@v2
        with:
          files: output/signed_installer/floorp-stub.installer.exe
          tag_name: ${{ steps.release.outputs.tag }}